version: 2.1

orbs:
  node: circleci/node@2.0.3
  cache-git: wink/git@1.0.0

executors:
  node:
    docker:
      - image: circleci/node:12

jobs:
  test:
    parameters:
      executor:
        description: The name of custom executor to use
        type: executor
        default: node
    executor: <<parameters.executor>>
    steps:
      - cache-git/checkout-repo
      - node/install-yarn
      - node/install-packages:
          cache-key: 'yarn.lock'
          pkg-manager: 'yarn'
      - run:
          name: Unit Testing
          command: |
            echo $REACT_APP_NODEJS_ENV_DEV | base64 --decode -i > .env
            yarn test
  deploy-to-dev:
    parameters:
      executor:
        description: The name of custom executor to use
        type: executor
        default: node
    executor: <<parameters.executor>>
    steps:
      - cache-git/checkout-repo
      - node/install-yarn
      - node/install-packages:
          cache-key: 'yarn.lock'
          pkg-manager: 'yarn'
      - run: yarn build
      - run:
          name: deploy to firebase
          command: |
            yarn add firebase-tools
            export PATH="$(npm bin):$PATH"
            firebase deploy --project "$DEV_FIREBASE_PROJECT" -p build --token "$DEV_FIREBASE_TOKEN" --non-interactive

workflows:
  main:
    jobs:
      - test
      - deploy-to-dev:
          requires:
            - test
          filters:
            branches:
              only:
                - feat/refactor
