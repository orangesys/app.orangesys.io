version: 2.1

orbs:
  # "cypress-io/cypress@1" installs the latest published
  # version "1.x.y" of the orb. We recommend you then use
  # the strict explicit version "cypress-io/cypress@1.x.y"
  # to lock the version and prevent unexpected CI changes
  cypress: cypress-io/cypress@1
  node: circleci/node@2.0.3
  cache-git: wink/git@1.0.0

executors:
  node:
    docker:
      - image: circleci/node:12

jobs:
  test:
    parameters:
      executor:
        description: The name of custom executor to use
        type: executor
        default: node
    executor: <<parameters.executor>>
    steps:
      - cache-git/checkout-repo
      - node/install-yarn
      - node/install-packages:
          cache-key: 'yarn.lock'
          pkg-manager: 'yarn'
      - run:
          name: Unit Testing
          command: |
            echo $REACT_APP_NODEJS_ENV_DEV | base64 --decode -i > .env
            yarn test
      # - run:
      #     name: Firebase Deploy Database
      #     command: yarn firebase deploy --project "$DEV_FIREBASE_PROJECT" --token "$FIREBASE_TOKEN" --non-interactive --only database
  deploy-to-dev:
    parameters:
      executor:
        description: The name of custom executor to use
        type: executor
        default: node
    executor: <<parameters.executor>>
    steps:
      - cache-git/checkout-repo
      - node/install-yarn
      - node/install-packages:
          cache-key: 'yarn.lock'
          pkg-manager: 'yarn'
      - run: yarn build
      - run: 
          name: deploy to firebase
          command: |
            yarn add firebase-tools
            export PATH="$(npm bin):$PATH"
            firebase deploy --project "dev-app-orangesys" -p build --token "$FIREBASE_TOKEN" --non-interactive

workflows:
  main:
    jobs:
      - test
      - cypress/run:
          yarn: true
          record: true
          filters:
            branches:
              only:
                - master
                - feat/refactor
      - deploy-dev:
          requires:
            - test
          filters:
            branches:
              only:
                - feat/refactor
